#!/bin/sh

# Usage: tmux-create-session [session_name] [working_directory]
# If no session_name provided, generates one from directory structure
# If no working_directory provided, uses current directory

WORKING_DIR="${2:-$(pwd)}"
cd "$WORKING_DIR"
if [ $? -ne 0 ]; then
    echo "Failed to open directory"
    return 1 2>/dev/null || exit 1
fi

if [ -n "$1" ]; then
    SESSION="$1"
else
    PARENT_DIR=$(basename "$(dirname "$(pwd)")" | sed 's/^\.//')
    BASE_DIR=$(basename "$(pwd)" | sed 's/^\.//')
    BASE_DIR=${BASE_DIR:0:30}

    # Special handling for worktree directories
    case "$PARENT_DIR" in
        .wt|.wts|.worktree|worktree|worktrees|.worktrees)
            GRANDPARENT_DIR=$(basename "$(dirname "$(dirname "$(pwd)")")" | sed 's/^\.//')
            SESSION="${GRANDPARENT_DIR}/${BASE_DIR}"
            ;;
        workspaces)
            SESSION="workspaces/${BASE_DIR}"
            ;;
        *)
            SESSION="${BASE_DIR}"
            ;;
    esac
fi

echo "Creating tmux session '$SESSION' in '$WORKING_DIR'..."

# Check if session already exists
if tmux has-session -t "$SESSION" 2>/dev/null; then
    echo "Session '$SESSION' already exists"
    # If in tmux, switch to session, otherwise attach
    if [ -n "$TMUX" ]; then
        tmux switch-client -t "$SESSION"
    else
        tmux attach-session -t "$SESSION"
    fi
    return 0 2>/dev/null || exit 0
fi

# Check capabilities
IS_GIT_REPO=false
if git rev-parse --is-inside-work-tree 2>/dev/null; then
    IS_GIT_REPO=true
fi
HAS_LAZYGIT=false
if command -v lazygit >/dev/null 2>&1; then
    HAS_LAZYGIT=true
fi
HAS_NVIM=false
if command -v nvim >/dev/null 2>&1; then
    HAS_NVIM=true
fi
HAS_OPENCODE=false
if command -v opencode >/dev/null 2>&1; then
    HAS_OPENCODE=true
fi
HAS_CLAUDECODE=false
if command -v claude >/dev/null 2>&1; then
    HAS_CLAUDECODE=true
fi

# Create new session
tmux new-session -d -s "$SESSION" -c "$WORKING_DIR"

# Git window
if [ "$IS_GIT_REPO" = true ]; then
    tmux new-window -t "$SESSION:2" -n 'git' -c "$WORKING_DIR"
    if [ "$HAS_LAZYGIT" = true ]; then
        tmux send-keys -t 'git' 'lazygit' C-m
    fi
else
    tmux new-window -t "$SESSION:2" -n 'no_git' -c "$WORKING_DIR"
fi

# Editor window
tmux new-window -t "$SESSION:3" -n 'vim' -c "$WORKING_DIR"
if [ "$HAS_NVIM" = true ]; then
    tmux send-keys -t 'vim' 'nvim' C-m
else
    tmux send-keys -t 'vim' 'vi' C-m
fi

# AI window
if [ "$HAS_OPENCODE" = true ]; then
    tmux new-window -t "$SESSION:4" -n 'ai' -c "$WORKING_DIR"
    tmux send-keys -t 'ai' 'opencode' C-m
elif [ "$HAS_CLAUDECODE" = true ]; then
    tmux new-window -t "$SESSION:4" -n 'ai' -c "$WORKING_DIR"
    tmux send-keys -t 'ai' 'claude' C-m
else
    tmux new-window -t "$SESSION:4" -n 'no_ai' -c "$WORKING_DIR"
fi

# If currently in tmux, switch to new session, otherwise attach
if [ -n "$TMUX" ]; then
    echo "Switching to tmux session '$SESSION'..."
    tmux switch-client -t "$SESSION:1"
else
    echo "Attaching to tmux session '$SESSION'..."
    tmux attach-session -t "$SESSION:1"
fi
