#!/usr/bin/env python3

import re
import shutil
import subprocess
import sys
from pathlib import Path


class Colors:
    """ANSI color codes for terminal output"""

    RED = "\033[0;31m"
    GREEN = "\033[0;32m"
    YELLOW = "\033[1;33m"
    BLUE = "\033[0;34m"
    NC = "\033[0m"  # No Color


class WorkspaceManager:
    def __init__(self):
        self.workspaces_dir = Path.home() / "workspaces"
        self.current_dir = Path.cwd()
        self.current_dir_name = self.get_workspace_folder_name(self.current_dir)
        self.link_name = self.get_link_name(self.current_dir)
        self.clean_dir_name = self.clean_folder_name(self.current_dir_name)
        self.clean_link_name = self.clean_folder_name(self.link_name)

    def is_worktree_dir(self, dir_path):
        """Check if we're in a worktree directory"""
        dir_name = dir_path.name
        return dir_name in {".worktrees", ".worktree", "worktrees", "worktree", ".wt"}

    def get_workspace_folder_name(self, current_dir):
        """Get the appropriate directory name for workspace folder"""
        # Always use current directory name as the workspace folder name
        return current_dir.name

    def get_link_name(self, current_dir):
        """Get the appropriate link name inside the workspace folder"""
        # Traverse up the directory stack to find a git repository
        # Start from the parent and work up
        current = current_dir.parent
        while current != current.parent:  # Stop when we reach the root
            # Check if this directory is a git repository
            if (current / ".git").exists():
                return current.name
            current = current.parent

        # If no git repo found, use the current directory name
        return current_dir.name

    def clean_folder_name(self, name):
        """Clean up folder names"""
        # Remove common prefixes and patterns
        name = re.sub(r"-clone(-|$)", "", name)  # Remove "-clone" suffix
        name = re.sub(r"^clone-", "", name)  # Remove "clone-" prefix
        name = re.sub(r"-+", "-", name)  # Replace multiple dashes with single dash
        name = re.sub(r"^-|-$", "", name)  # Remove leading/trailing dashes
        return name

    def print_info(self, message):
        """Print info message with blue color"""
        print(f"{Colors.BLUE}ℹ{Colors.NC} {message}")

    def print_success(self, message):
        """Print success message with green color"""
        print(f"{Colors.GREEN}✓{Colors.NC} {message}")

    def print_warning(self, message):
        """Print warning message with yellow color"""
        print(f"{Colors.YELLOW}⚠{Colors.NC} {message}")

    def print_error(self, message):
        """Print error message with red color"""
        print(f"{Colors.RED}✗{Colors.NC} {message}")

    def check_prerequisites(self):
        """Check prerequisites for running the script"""
        # Check if fzf is available
        if not shutil.which("fzf"):
            self.print_error(
                "fzf is required but not installed. Please install fzf first."
            )
            return False

        # Check if we're already in the workspaces directory
        if str(self.current_dir).startswith(str(self.workspaces_dir)):
            self.print_error(
                f"You're already inside the workspaces directory. Please run this script from outside {self.workspaces_dir}."
            )
            return False

        return True

    def get_workspace_folders(self):
        """Get list of existing workspace folders"""
        if self.workspaces_dir.exists():
            folders = []
            for item in self.workspaces_dir.iterdir():
                if item.is_dir():
                    folders.append(item.name)
            return sorted(folders)
        return []

    def build_fzf_options(self):
        """Build fzf options and run fzf for selection"""
        existing_folders = self.get_workspace_folders()

        # Check if current directory name (original or cleaned) matches any existing workspace folder
        default_selection = ""
        if self.clean_dir_name in existing_folders:
            default_selection = self.clean_dir_name
            self.print_info(
                f"Found existing workspace folder matching cleaned directory name: {self.clean_dir_name}"
            )
        elif self.current_dir_name in existing_folders:
            default_selection = self.current_dir_name
            self.print_info(
                f"Found existing workspace folder matching current directory name: {self.current_dir_name}"
            )

        # Prepare options for fzf
        options = []
        if existing_folders:
            options.extend(existing_folders)

        options.append("── Create new folder ──")

        if self.clean_dir_name != self.current_dir_name:
            options.append(f"Create new: {self.clean_dir_name} (cleaned)")
            options.append(f"Create new: {self.current_dir_name} (original)")
        else:
            options.append(f"Create new: {self.current_dir_name}")

        options.append("Create new: [custom name]")

        # Remove empty lines
        options = [opt for opt in options if opt.strip()]

        # Build fzf command
        header = f"Current directory: {self.current_dir_name}"
        if self.clean_dir_name != self.current_dir_name:
            header += f" | Cleaned: {self.clean_dir_name}"
        if self.link_name != self.current_dir_name:
            header += f" | Link name: {self.link_name}"

        preview_cmd = f"echo 'Will create directory: {self.workspaces_dir}/{{}}/' && echo 'Will create symlink: {self.workspaces_dir}/{{}}/{self.link_name} -> {self.current_dir}'"

        fzf_cmd = [
            "fzf",
            "--height=~50%",
            "--border=rounded",
            "--prompt=Select workspace folder: ",
            f"--header={header}",
            f"--preview={preview_cmd}",
            "--preview-window=up:3:wrap",
        ]

        if default_selection:
            fzf_cmd.extend([f"--query={default_selection}", "--select-1"])

        try:
            # Run fzf
            result = subprocess.run(
                fzf_cmd, input="\n".join(options), text=True, capture_output=True
            )
            if result.returncode == 0:
                return result.stdout.strip()
            elif result.returncode == 130:  # User cancelled with Ctrl+C
                return ""
            else:
                self.print_error(f"fzf failed with return code {result.returncode}")
                return ""
        except Exception as e:
            self.print_error(f"Error running fzf: {e}")
            return ""

    def create_link(self, target_folder, link_name):
        """Create directory and symlink"""
        target_dir = self.workspaces_dir / target_folder
        target_path = target_dir / link_name

        # Check if target directory already exists
        if target_dir.exists():
            if not target_dir.is_dir():
                self.print_error(
                    f"File {target_dir} already exists and is not a directory."
                )
                return False

            # Directory exists, check if symlink inside already exists
            if target_path.exists():
                if target_path.is_symlink():
                    existing_target = target_path.resolve()
                    if existing_target == self.current_dir.resolve():
                        self.print_warning(
                            "Link already exists and points to current directory."
                        )
                        return True
                    else:
                        self.print_error(
                            f"Symlink {target_path} already exists and points to: {existing_target}"
                        )
                        return False
                else:
                    self.print_error(
                        f"File or directory {target_path} already exists and is not a symlink."
                    )
                    return False
        else:
            # Create the directory
            target_dir.mkdir(parents=True, exist_ok=True)
            self.print_info(f"Created directory: {target_dir}")

        # Create the symlink inside the directory
        target_path.symlink_to(self.current_dir)
        self.print_success(f"Created symlink: {target_path} -> {self.current_dir}")
        return True

    def main(self):
        """Main execution function"""
        # Check prerequisites first
        if not self.check_prerequisites():
            return False

        # Ensure workspaces directory exists
        self.workspaces_dir.mkdir(parents=True, exist_ok=True)

        self.print_info("Adding current directory to workspace...")
        self.print_info(f"Current directory: {self.current_dir}")
        self.print_info(f"Workspaces directory: {self.workspaces_dir}")
        if self.link_name != self.current_dir_name:
            self.print_info(
                f"Detected worktree: folder will be '{self.current_dir_name}', link will be '{self.link_name}'"
            )
        print()

        # Get user selection
        selection = self.build_fzf_options()

        # Track the actual folder name that will be created
        target_folder_name = ""

        # Handle the selection
        if selection == "── Create new folder ──":
            self.print_error("Invalid selection. Please choose a valid option.")
            return False
        elif selection == f"Create new: {self.clean_dir_name} (cleaned)":
            target_folder_name = self.clean_dir_name
            self.print_info(f"Creating new workspace folder: {self.clean_dir_name}")
            if not self.create_link(self.clean_dir_name, self.clean_link_name):
                return False
        elif selection == f"Create new: {self.current_dir_name} (original)":
            target_folder_name = self.current_dir_name
            self.print_info(f"Creating new workspace folder: {self.current_dir_name}")
            if not self.create_link(self.current_dir_name, self.link_name):
                return False
        elif selection == f"Create new: {self.current_dir_name}":
            target_folder_name = self.current_dir_name
            self.print_info(f"Creating new workspace folder: {self.current_dir_name}")
            if not self.create_link(self.current_dir_name, self.link_name):
                return False
        elif selection == "Create new: [custom name]":
            print()
            custom_name = input(
                f"Enter custom folder name [{self.clean_dir_name}]: "
            ).strip()
            custom_name = custom_name or self.clean_dir_name

            # Validate folder name
            if not re.match(r"^[a-zA-Z0-9._-]+$", custom_name):
                self.print_error(
                    "Invalid folder name. Use only alphanumeric characters, dots, underscores, and hyphens."
                )
                return False

            target_folder_name = custom_name
            self.print_info(f"Creating new workspace folder: {custom_name}")
            if not self.create_link(custom_name, self.link_name):
                return False
        elif selection == "":
            self.print_warning("No selection made. Exiting.")
            return True
        else:
            target_folder_name = selection
            self.print_info(f"Using existing workspace folder: {selection}")
            if not self.create_link(selection, self.link_name):
                return False

        print()
        self.print_success("Workspace setup complete!")
        self.print_info(
            f"You can now access your project from: {self.workspaces_dir}/{target_folder_name}/{self.link_name}"
        )
        return True


def main():
    """Entry point"""
    manager = WorkspaceManager()
    if not manager.main():
        sys.exit(1)


if __name__ == "__main__":
    main()
