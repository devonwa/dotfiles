#!/bin/sh

if [ $# -eq 0 ]; then
    echo "Usage: $0 <branch-name>"
    exit 1
fi

BRANCH_NAME="$1"
CURRENT_DIR=$(pwd)
PARENT_DIR=$(dirname "$CURRENT_DIR")
WORKTREE_DIR="$PARENT_DIR/$BRANCH_NAME"

# Create worktree
echo "Creating worktree for branch '$BRANCH_NAME' in '$WORKTREE_DIR'..."
git worktree add "$WORKTREE_DIR" "$BRANCH_NAME"

if [ $? -ne 0 ]; then
    echo "Failed to create worktree"
    exit 1
fi

# Switch to worktree directory
cd "$WORKTREE_DIR" || exit 1

# If it is a python project, build the virtual env
if [ -f "requirements.txt" ] || [ -f "pyproject.toml" ] || [ -f "setup.py" ] || [ -f "Pipfile" ] || [ -f "uv.lock" ]; then
    echo "Python project detected, setting up virtual environment..."
    if command -v uv >/dev/null 2>&1; then
        uv venv .venv
        . .venv/bin/activate
        
        # Install dependencies
        if [ -f "uv.lock" ]; then
            echo "Installing dependencies from uv.lock..."
            uv sync
        elif [ -f "requirements.txt" ]; then
            echo "Installing requirements from requirements.txt..."
            uv pip install -r requirements.txt
        elif [ -f "pyproject.toml" ]; then
            echo "Installing project with pyproject.toml..."
            uv pip install -e .
        elif [ -f "setup.py" ]; then
            echo "Installing project with setup.py..."
            uv pip install -e .
        elif [ -f "Pipfile" ] && command -v pipenv >/dev/null 2>&1; then
            echo "Installing dependencies with pipenv..."
            pipenv install
        fi
    else
        echo "Warning: uv not found, skipping virtual environment setup"
    fi
fi

# Allow direnv
echo "Running 'direnv allow' in worktree directory..."
direnv allow

# Return to original directory before creating tmux session
cd "$CURRENT_DIR"

# Create tmux session using shared script
"$(dirname "$0")/tmux-create-session" "" "$WORKTREE_DIR"
